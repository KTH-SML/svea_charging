<?xml version="1.0"?>
<launch>
    <!-- Launch file arguments -->
    <arg name="map"             default="sml"/>
    <arg name="is_sim"          default="true"/>
    <arg name="use_foxglove"    default="true"/>
    <arg name="initial_pose_x"  default="-2.5"/> <!-- changed-->
    <arg name="initial_pose_y"  default="0.0"/> <!-- changed-->
    <arg name="initial_pose_a"  default="0.0" /> <!-- wrt to map--> <!-- changed-->
    <arg name="map_path" default="$(find-pkg-share svea_core)/maps/$(var map).yaml"/>
    <arg name="state" default="[-7.4, -15.3, 0.9, 0.0]" /> <!-- should be changed-->
    
    <arg name="use_aruco_camera" default="true"/>
    <arg name="aruco_dictionary" default="DICT_4X4_50"/>
    <arg name="aruco_camera_index" default="3"/>
    <arg name="aruco_marker_length_m" default="0.1"/>
    <arg name="aruco_display" default="false"/>
    <arg name="aruco_loop_hz" default="30.0"/>
    <arg name="aruco_frame_id" default="camera"/>
    <arg name="aruco_camera_backend" default="V4L2"/>
    <arg name="aruco_use_aruco_detector_api" default="false"/>
    <arg name="aruco_publish_debug_image" default="true"/>
    <arg name="aruco_jpeg_quality" default="80"/>
    <arg name="aruco_generate_marker_on_startup" default="false"/>
    <arg name="aruco_marker_id" default="0"/>
    <arg name="aruco_marker_size_px" default="400"/>
    <arg name="aruco_output" default="aruco_marker.png"/>
    <arg name="aruco_calibration_file" default=""/>
    <arg name="aruco_focal_length_px" default="-1.0"/>

    <!-- Start Map Server and Foxglove -->
    <include file="$(find-pkg-share svea_core)/launch/map_and_foxglove.xml">
        <arg name="map" value="$(var map)" />
        <arg name="use_foxglove" value="$(var use_foxglove)" />
    </include>   
    
    <let name="name" value="self"/>

    <!-- Start Svea Core -->
    <include file="$(find-pkg-share svea_core)/launch/svea_mocap.xml">
        <arg name="name" value="$(var name)" />
        <arg name="is_sim" value="$(var is_sim)" />
        <arg name="initial_pose_x" value="$(var initial_pose_x)" />
        <arg name="initial_pose_y" value="$(var initial_pose_y)" />
        <arg name="initial_pose_a" value="$(var initial_pose_a)" />
        <arg name="state" value="$(var state)" />
        <arg name="map" value="$(var map)" />
    </include>   

    <group if="$(var is_sim)">
        <push-ros-namespace namespace="$(var name)"/>
        <!-- Start stanleyController -->
        <node name="stanleyExecutable" pkg="svea_charging" exec="stanleyExecutable.py" output="screen">
            <param name="use_rviz" value="$(var use_foxglove)"/>
            <param name="is_sim" value="$(var is_sim)"/>
            <!-- Allow namespace -->
            <param name="steering_top" value="lli/ctrl/steering"/>
            <param name="throttle_top" value="lli/ctrl/throttle"/>
            <param name="highgear_top" value="lli/ctrl/highgear"/>
            <param name="diff_top" value="lli/ctrl/diff"/>
        </node>

        <node if="$(var use_aruco_camera)" name="aruco_camera_test" pkg="svea_charging" exec="aruco_camera_test.py" output="screen">
            <param name="dictionary" value="$(var aruco_dictionary)"/>
            <param name="camera_index" value="$(var aruco_camera_index)"/>
            <param name="marker_length_m" value="$(var aruco_marker_length_m)"/>
            <param name="display" value="$(var aruco_display)"/>
            <param name="loop_hz" value="$(var aruco_loop_hz)"/>
            <param name="frame_id" value="$(var aruco_frame_id)"/>
            <param name="camera_backend" value="$(var aruco_camera_backend)"/>
            <param name="use_aruco_detector_api" value="$(var aruco_use_aruco_detector_api)"/>
            <param name="publish_debug_image" value="$(var aruco_publish_debug_image)"/>
            <param name="jpeg_quality" value="$(var aruco_jpeg_quality)"/>
            <param name="generate_marker_on_startup" value="$(var aruco_generate_marker_on_startup)"/>
            <param name="marker_id" value="$(var aruco_marker_id)"/>
            <param name="marker_size_px" value="$(var aruco_marker_size_px)"/>
            <param name="output" value="$(var aruco_output)"/>
            <param name="calibration_file" value="$(var aruco_calibration_file)"/>
            <param name="focal_length_px" value="$(var aruco_focal_length_px)"/>
        </node>
    </group>

    <group unless="$(var is_sim)">
        <push-ros-namespace namespace="$(var name)"/>
        <!-- Start stanleyController -->
        <node name="stanleyExecutable" pkg="svea_charging" exec="stanleyExecutable.py" output="screen">
            <param name="use_rviz" value="$(var use_foxglove)"/>
            <param name="is_sim" value="$(var is_sim)"/>
            <param name="localization/base_frame" value="$(var name)/base_link"/>
        </node>

        <node if="$(var use_aruco_camera)" name="aruco_camera_test" pkg="svea_charging" exec="aruco_camera_test.py" output="screen">
            <param name="dictionary" value="$(var aruco_dictionary)"/>
            <param name="camera_index" value="$(var aruco_camera_index)"/>
            <param name="marker_length_m" value="$(var aruco_marker_length_m)"/>
            <param name="display" value="$(var aruco_display)"/>
            <param name="loop_hz" value="$(var aruco_loop_hz)"/>
            <param name="frame_id" value="$(var aruco_frame_id)"/>
            <param name="camera_backend" value="$(var aruco_camera_backend)"/>
            <param name="use_aruco_detector_api" value="$(var aruco_use_aruco_detector_api)"/>
            <param name="publish_debug_image" value="$(var aruco_publish_debug_image)"/>
            <param name="jpeg_quality" value="$(var aruco_jpeg_quality)"/>
            <param name="generate_marker_on_startup" value="$(var aruco_generate_marker_on_startup)"/>
            <param name="marker_id" value="$(var aruco_marker_id)"/>
            <param name="marker_size_px" value="$(var aruco_marker_size_px)"/>
            <param name="output" value="$(var aruco_output)"/>
            <param name="calibration_file" value="$(var aruco_calibration_file)"/>
            <param name="focal_length_px" value="$(var aruco_focal_length_px)"/>
        </node>
    </group>

</launch>
